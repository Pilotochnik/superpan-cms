{% extends 'admin_panel/base.html' %}

{% block page_title %}Ключи доступа к проекту{% endblock %}
{% block page_subtitle %}{{ project.name }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-admin">
        <li class="breadcrumb-item"><a href="{% url 'admin_panel:dashboard' %}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admin_panel:projects_list' %}">Проекты</a></li>
        <li class="breadcrumb-item active">Ключи доступа</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Project Info -->
<div class="card admin-card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-2">{{ project.name }}</h4>
                <p class="text-muted mb-0">{{ project.description|default:"Нет описания" }}</p>
                {% if project.address %}
                <small class="text-muted">
                    <i class="bi bi-geo-alt me-1"></i>{{ project.address }}
                </small>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <div class="mb-2">
                    <strong>Бюджет:</strong> {{ project.budget|floatformat:0 }}₽
                </div>
                <div class="mb-2">
                    <strong>Потрачено:</strong> {{ project.spent_amount|floatformat:0 }}₽
                </div>
                <a href="{% url 'admin_panel:create_access_key' %}?project={{ project.pk }}" class="btn btn-success btn-admin">
                    <i class="bi bi-key me-2"></i>Выдать доступ
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Access Keys Table -->
<div class="card admin-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-key me-2"></i>
            Ключи доступа ({{ access_keys.count }})
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-admin mb-0">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Ключ доступа</th>
                        <th>Описание</th>
                        <th>Статус</th>
                        <th>Создан</th>
                        <th>Истекает</th>
                        <th>Использован</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for access_key in access_keys %}
                    <tr>
                        <td>
                            {% if access_key.assigned_to %}
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2" style="width: 30px; height: 30px; background: linear-gradient(135deg, #2c5aa0 0%, #1e3d72 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem;">
                                    {{ access_key.assigned_to.first_name.0|default:access_key.assigned_to.email.0|upper }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ access_key.assigned_to.get_full_name }}</div>
                                    <small class="text-muted">{{ access_key.assigned_to.email }}</small>
                                </div>
                            </div>
                            {% else %}
                            <span class="text-muted">Не назначен</span>
                            {% endif %}
                        </td>
                        <td>
                            <code class="small">{{ access_key.key|slice:":8" }}...{{ access_key.key|slice:"-4:" }}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                    onclick="copyToClipboard('{{ access_key.key }}')" 
                                    title="Копировать">
                                <i class="bi bi-copy"></i>
                            </button>
                        </td>
                        <td>
                            {{ access_key.description|default:"—" }}
                        </td>
                        <td>
                            {% if access_key.is_active %}
                                {% if access_key.expires_at and access_key.expires_at < now %}
                                    <span class="badge bg-warning">Истек</span>
                                {% else %}
                                    <span class="badge bg-success">Активен</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">Неактивен</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ access_key.created_at|date:"d.m.Y H:i" }}</small>
                            <br>
                            <small class="text-muted">{{ access_key.created_by.get_full_name }}</small>
                        </td>
                        <td>
                            {% if access_key.expires_at %}
                                <small>{{ access_key.expires_at|date:"d.m.Y H:i" }}</small>
                            {% else %}
                                <span class="text-muted">Бессрочно</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if access_key.used_at %}
                                <small class="text-success">{{ access_key.used_at|date:"d.m.Y H:i" }}</small>
                            {% else %}
                                <span class="text-muted">Не использован</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" action="{% url 'admin_panel:toggle_access_key' access_key.pk %}" 
                                  class="d-inline" 
                                  onsubmit="return confirm('Изменить статус ключа доступа?')">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm {% if access_key.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}" 
                                        title="{% if access_key.is_active %}Деактивировать{% else %}Активировать{% endif %}">
                                    <i class="bi bi-{% if access_key.is_active %}pause{% else %}play{% endif %}"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="bi bi-key" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">Ключи доступа не найдены</p>
                            <a href="{% url 'admin_panel:create_access_key' %}?project={{ project.pk }}" class="btn btn-primary btn-admin mt-2">
                                <i class="bi bi-plus me-2"></i>Создать первый ключ
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Help Card -->
<div class="card admin-card mt-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Справка по ключам доступа
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6>Что такое ключи доступа:</h6>
                <p class="small text-muted">
                    Ключи доступа позволяют предоставить пользователям доступ к конкретному проекту 
                    без необходимости добавлять их напрямую в команду.
                </p>
            </div>
            <div class="col-md-4">
                <h6>Статусы ключей:</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-success me-2">Активен</span> Ключ работает</li>
                    <li><span class="badge bg-warning me-2">Истек</span> Срок действия истек</li>
                    <li><span class="badge bg-secondary me-2">Неактивен</span> Ключ отключен</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6>Безопасность:</h6>
                <p class="small text-muted">
                    Ключи можно деактивировать в любой момент. 
                    Истекшие ключи автоматически становятся недействительными.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Можно добавить уведомление об успешном копировании
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = '<i class="bi bi-check me-2"></i>Ключ скопирован в буфер обмена';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}
</script>
{% endblock %}
